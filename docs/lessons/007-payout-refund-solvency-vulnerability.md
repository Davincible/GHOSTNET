# ArcadeCore: Payout + Refund Solvency Vulnerability

**Date:** 2026-01-22  
**Severity:** CRITICAL  
**Component:** `packages/contracts/src/arcade/ArcadeCore.sol`  
**Found by:** Invariant Testing  
**Status:** FIXED (2026-01-22)

## Summary

Invariant testing discovered a critical solvency vulnerability in ArcadeCore. When a session is ACTIVE, both `creditPayout` and `emergencyRefund` can be called, allowing a player to receive more tokens than the session's prize pool contains.

## Vulnerability Details

### Attack Sequence

1. Player deposits 100 tokens (net 95 after 5% rake goes to prize pool)
2. Game calls `creditPayout(player, 50)` - 50 tokens credited to pending
3. Game calls `emergencyRefund(player, 95)` - 95 tokens credited to pending
4. Player has 145 tokens pending but contract only has 95 tokens

### Root Cause

`creditPayout` updates `session.totalPaid` but does NOT decrement `sessionDeposits[player]`.

`emergencyRefund` checks `amount > sessionDeposits[player]` which is still the full original deposit amount.

```solidity
// In creditPayout - only updates session totals
session.totalPaid += totalDisbursement;
// sessionDeposits[player] NOT decremented

// In emergencyRefund - checks stale deposit
uint256 netDeposit = $.sessionDeposits[depositKey];
if (amount > netDeposit) revert RefundExceedsDeposit();
// netDeposit still equals original deposit!
```

### Impact

- Contract becomes insolvent (pending payouts > balance)
- Players cannot withdraw their legitimate winnings
- Malicious or buggy game contracts can drain funds

### Proof of Concept

See `test/arcade/ArcadeCore.Invariant.t.sol`:
- `ArcadeCoreVulnerabilityTest.test_VULNERABILITY_PayoutPlusRefundCausesInsolvency()`

Test output:
```
=== SOLVENCY CHECK ===
Total pending payouts: 142500000000000000000  (142.5 tokens)
Contract balance: 95000000000000000000        (95 tokens)
Shortfall: 47500000000000000000               (47.5 tokens)

VULNERABILITY CONFIRMED: Contract is insolvent (balance < pending)
```

## Recommended Fixes

### Option 1: Block refunds after payouts (Simplest)

Add a flag to track if session has disbursed any payouts:

```solidity
mapping(uint256 sessionId => bool hasPayouts) sessionHasPayouts;

// In creditPayout
sessionHasPayouts[sessionId] = true;

// In emergencyRefund
if (sessionHasPayouts[sessionId]) revert RefundsBlockedAfterPayouts();
```

### Option 2: Decrement deposits on payout (More Complex)

Track per-player payout allocation and decrement deposit accordingly:

```solidity
// In creditPayout for a specific player
$.sessionDeposits[depositKey] -= proportionalAmount;
```

This is more complex because payouts may not be tied to specific deposits.

### Option 3: Only allow refunds on CANCELLED sessions (Restrictive)

Only allow `emergencyRefund` when `session.state == CANCELLED` AND no payouts have been made:

```solidity
if (session.state != SessionState.CANCELLED) revert OnlyCancelledSessions();
if (session.totalPaid > 0) revert PayoutsAlreadyMade();
```

## Safe Path

The test `test_CancelledSession_NoVulnerability` shows the safe path:
1. Cancel session BEFORE any payouts
2. Payouts are blocked on CANCELLED sessions
3. Refunds work correctly

## Invariant Test Constraints

The invariant test handler (`ArcadeCoreHandler`) constrains operations to avoid this vulnerability while testing other invariants:

```solidity
// In emergencyRefund handler
if (sessionHasPayouts[sessionId]) return; // Don't test vulnerable path
```

This allows the invariant suite to verify other properties hold while the vulnerability exists.

## Files Changed

- Added: `test/arcade/ArcadeCore.Invariant.t.sol` - Comprehensive invariant and fuzz tests
- Documents vulnerability and provides proof of concept

## Lessons Learned

1. **Invariant testing finds bugs unit tests miss** - The vulnerability was not obvious from reading code or writing targeted tests
2. **Accounting invariants must be holistic** - Individual operations may be correct but their composition can break invariants  
3. **State that affects multiple operations must be synchronized** - `sessionDeposits` affects both payouts and refunds but is only updated by one
4. **Handler constraints document known issues** - When you find a bug, constrain the handler to test other properties

## Applied Fix

**Option 1 was implemented**: Block refunds after any payouts have been made.

Added `RefundsBlockedAfterPayouts` error and check to:
- `emergencyRefund()` - Single player refund
- `batchEmergencyRefund()` - Batch refund  
- `claimExpiredRefund()` - Player-initiated refund for cancelled sessions

```solidity
// In IArcadeCore.sol
error RefundsBlockedAfterPayouts();

// In all refund functions
if (session.totalPaid > 0) revert RefundsBlockedAfterPayouts();
```

This is the simplest fix with minimal gas overhead (single storage read that's already cached).

## Files Changed

- `src/arcade/ArcadeCore.sol` - Added refund blocking check to 3 functions
- `src/arcade/interfaces/IArcadeCore.sol` - Added `RefundsBlockedAfterPayouts` error
- `test/arcade/ArcadeCore.Invariant.t.sol` - Comprehensive invariant and fuzz tests

## Related Tests

- `ArcadeCoreVulnerabilityTest` - Demonstrates the vulnerability (now passes with fix)
- `ArcadeCoreInvariantTest` - Tests system invariants 
- `ArcadeCoreFuzzTest` - Property-based tests for individual operations
